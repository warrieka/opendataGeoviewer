<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>test2</title>
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/dojo/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/esri/css/esri.css" />

    <style>
      html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
      #map{ margin: 0; padding: 0; }

      /* center the image in the popup */
      .esriViewPopup .gallery { margin: 0 auto !important; }
    </style>
    <script>
      var dojoConfig = { 
        parseOnLoad: true,
        packages: [{
          "name": "extras",
         location: location.pathname.replace(/\/[^/]*$/, '') + "/extras"
        }]
      };
    </script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.2"></script>
    
    <script>
      dojo.require("dijit.layout.BorderContainer");
      dojo.require("dijit.layout.ContentPane");
      dojo.require("esri.map");
      dojo.require("esri.dijit.Popup");
      dojo.require("extras.ClusterLayer");
      
      var map, clusterLayer;
      function init() {
        var initExtent = new esri.geometry.Extent({"xmin":467840,"ymin":6646858,"xmax":507587,"ymax":6687675,"spatialReference":{"wkid":102100}});
        var popupOptions = {
          "markerSymbol": new esri.symbol.SimpleMarkerSymbol("circle", 20, null, new dojo.Color([0, 0, 0, 0.25])),
          "marginLeft": "20", 
          "marginTop": "20"
        };
        var popup = new esri.dijit.Popup(popupOptions, dojo.create("div"));
        map = new esri.Map("map", {
          extent: initExtent,
          infoWindow: popup
        });
        
        var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer");
        map.addLayer(basemap);
        
        
        dojo.connect(map, "onLoad", function() { 
          dojo.connect(dijit.byId("map"), "resize", map, map.resize);
          
		  dojo.connect(map, "onClick", function(evt) {
			   alert( evt.mapPoint.x +" , "+ evt.mapPoint.y );
			});          
		  });
		}
	  
	  var data;
      function getContent() {
			var requestHandle = esri.request({
				url:"http://api.antwerpen.be/v1/infrastructuur/papiermand.jsonp",
				callbackParamName: "callback",
				load: requestSucceeded,
				error: requestFailed
			});
			}
	  function requestSucceeded(response, io) {
			      data = response;
			      addClusters( response.papiermand );
    		}

	  function requestFailed(error, io) {
     			 console.log("Failed: ", error);
    		} 


      function addClusters(resp) {
        var photoInfo = {};
        var wgs = new esri.SpatialReference({ "wkid": 4326 });
        photoInfo.data = dojo.map(resp, function(p) {
          var latlng = new esri.geometry.Point(parseFloat(p.point_lng), parseFloat(p.point_lat), wgs);
          var webMercator = esri.geometry.geographicToWebMercator(latlng);
          var attributes = resp;
          return { "x": webMercator.x, "y": webMercator.y, "attributes": attributes };
        });

        // cluster layer that uses OpenLayers style clustering
        clusterLayer = new extras.ClusterLayer({ 
          "data": photoInfo.data,
          "distance": 100,
          "id": "clusters", 
          "labelColor": "#fff",
          "labelOffset": 10,
          "resolution": map.extent.getWidth() / map.width,
          "singleColor": "#888",
          //"singleTemplate": popupTemplate
        });
        var defaultSym = new esri.symbol.SimpleMarkerSymbol().setSize(4);
        var renderer = new esri.renderer.ClassBreaksRenderer(
          defaultSym, 
          "clusterCount"
        );
        var blue = new esri.symbol.PictureMarkerSymbol("http://static.arcgis.com/images/Symbols/Shapes/BluePin1LargeB.png", 32, 32).setOffset(0, 15);
        var green = new esri.symbol.PictureMarkerSymbol("http://static.arcgis.com/images/Symbols/Shapes/GreenPin1LargeB.png", 64, 64).setOffset(0, 15);
        var red = new esri.symbol.PictureMarkerSymbol("http://static.arcgis.com/images/Symbols/Shapes/RedPin1LargeB.png", 72, 72).setOffset(0, 15);
        renderer.addBreak(0, 2, blue);
        renderer.addBreak(2, 200, green);
        renderer.addBreak(200, 1001, red);

        clusterLayer.setRenderer(renderer);
        map.addLayer(clusterLayer);

        // close the info window when the map is clicked
        // dojo.connect(map, "onClick", cleanUp);
        // close the info window when esc is pressed
        dojo.connect(map, "onKeyDown", function(e) {
          if ( e.keyCode == 27 ) { 
            cleanUp();
          }
        });
      }

      function cleanUp() {
        map.infoWindow.hide();
        clusterLayer.clearSingles();
      }

      function error(err) {
        console.log("something failed: ", err);
      }

      // show cluster extents 
      function showExtents() {
        var extents = new esri.layers.GraphicsLayer();
        var sym = new esri.symbol.SimpleFillSymbol().setColor(new dojo.Color([205,193,197,0.5]));

        dojo.forEach(clusterLayer._clusters, function(c) {
          var e = c.attributes.extent;
          extents.add(new esri.Graphic(new esri.geometry.Extent(e[0], e[1], e[2], e[3]), sym));
        }, this);
        map.addLayer(extents, 0);
        console.log("added extents");
      }
      
      dojo.ready(init);
    </script>
  </head>
  
  <body class="tundra">
    <div data-dojo-type="dijit.layout.BorderContainer" 
         data-dojo-props="design:'headline',gutters:false" 
         style="width: 100%; height: 100%; margin: 0;">
      <div id="map" 
           data-dojo-type="dijit.layout.ContentPane" 
           data-dojo-props="region:'center'"> 
      </div>
    </div>
  </body>
</html>

